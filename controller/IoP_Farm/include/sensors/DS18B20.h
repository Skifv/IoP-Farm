/*
 * Цифровой датчик температуры DS18B20
 * 
 * Принцип работы:
 * 1. Физическая конструкция: 
 *    - Датчик представляет собой цифровой термометр с уникальным 64-битным серийным номером
 *    - Содержит встроенный термочувствительный элемент и 12-битный АЦП для преобразования температуры
 *    - Доступен в различных корпусах: TO-92 (обычная версия), водонепроницаемый с кабелем, и др.
 * 
 * 2. Принцип измерения:
 *    - Измерение основано на изменении характеристик полупроводника при изменении температуры
 *    - Встроенный АЦП преобразует температуру в цифровое значение с разрешением 9-12 бит (0.5°C-0.0625°C)
 *    - Значение температуры хранится во внутреннем регистре датчика в формате с разрешением 1/16 градуса
 *    - Датчик имеет уникальный заводской серийный номер, что позволяет подключать несколько устройств к одной шине
 * 
 * 3. Подключение:
 *    - Используется однопроводной интерфейс 1-Wire, требующий только одну линию данных
 *    - Схема подключения:
 *      Черный провод (GND) → GND ESP32
 *      Красный провод (VCC) → 3.3V
 *      Желтый провод (DATA) → цифровой пин ESP32 (требуется подтягивающий резистор 4.7K к VCC)
 *    - При подключении нескольких датчиков все они соединяются параллельно к одной шине 1-Wire
 *    - https://voltiq.ru/ds18b20-esp32-connection/
 * 
 * 4. Протокол связи:
 *    - Использует протокол 1-Wire для передачи данных по одной линии
 *    - Обмен данными начинается с сигнала сброса от микроконтроллера
 *    - Для идентификации устройств используется 64-битный серийный номер (8 байт)
 *    - Поддерживает CRC для проверки целостности данных (контрольная сумма)
 *    - Процесс измерения:
 *      1. Микроконтроллер отправляет команду Convert T
 *      2. Датчик выполняет преобразование температуры (до 750 мс при 12-битном разрешении)
 *      3. Результат записывается во внутренний регистр
 *      4. Микроконтроллер считывает данные из регистра командой Read Scratchpad
 * 
 * 5. Характеристики:
 *    - Рабочее напряжение: 3.3V
 *    - Диапазон измерения: -55°C до +125°C
 *    - Точность: ±0.5°C в диапазоне -10°C до +85°C
 *    - Разрешение: настраиваемое от 9 до 12 бит (от 0.5°C до 0.0625°C)
 *    - Время преобразования: от 93.75 мс (9 бит) до 750 мс (12 бит)
 *    - Каждый датчик имеет уникальный 64-битный заводской серийный номер
 * 
 * 6. Важные замечания:
 *    - При 12-битном разрешении время преобразования составляет около 750 мс
 *    - При подключении на большие расстояния может потребоваться снижение сопротивления подтягивающего резистора
 *    - Водонепроницаемые версии датчика позволяют измерять температуру в жидкости (наш вариант)
 *    - При возникновении проблем с чтением, проверьте качество соединения и подтягивающий резистор
 *    - Возможные ошибочные значения: +85°C (ошибка превышения времени или неинициализированный датчик), -127°C (ошибка CRC)
 */

// Датчик температуры воды/воздуха
#pragma once

#include "sensors/ISensor.h"
#include "config/constants.h"
#include "sensors/DS18B20Common.h"
#include <memory>

namespace farm::sensors
{
    class DS18B20 : public ISensor
    {
    private:
        uint8_t pin;
        
        // Адрес устройства (для нескольких датчиков на одной шине)
        uint8_t deviceAddress[8];
        
        std::shared_ptr<DS18B20Resources> resources;
        
    public:
        DS18B20(std::shared_ptr<log::ILogger> logger, uint8_t pin);     
        ~DS18B20();
        
        bool initialize() override;
        
        // Считать температуру в градусах Цельсия
        float read() override;
        
        void setDeviceAddress(const uint8_t* address);
    };
} 