/*
 * Ультразвуковой датчик уровня воды HC-SR04
 * 
 * Принцип работы:
 * 1. Физическая конструкция: 
 *    - Датчик состоит из ультразвукового передатчика (Trig) и приемника (Echo)
 *    - Передатчик излучает ультразвуковой импульс, который, отразившись от поверхности, возвращается к приемнику
 *    - На плате расположены электронные компоненты для обработки сигналов
 * 
 * 2. Принцип измерения:
 *    - На пин Trig подается импульс длительностью 10 микросекунд
 *    - Датчик излучает 8 ультразвуковых импульсов с частотой 40 кГц
 *    - Импульсы отражаются от поверхности воды и возвращаются к приемнику
 *    - Пин Echo переходит в высокое состояние на время прохождения сигнала туда и обратно
 *    - Измеряется длительность высокого состояния пина Echo и преобразуется в расстояние
 *    - Расстояние (см) = время (мкс) / 58 (формула учитывает скорость звука в воздухе)
 * 
 * 3. Подключение:
 *    - VCC → 5V (важно использовать 5V для стабильной работы)
 *    - GND → GND ESP32
 *    - Trig → цифровой пин ESP32 (например, GPIO5)
 *    - Echo → цифровой пин через делитель напряжения на ESP32 (например, GPIO18)
 *      Примечание: Так как Echo выдает 5В, а ESP32 работает с 3.3В, рекомендуется 
 *      использовать делитель напряжения или логический преобразователь уровня
 *    - https://microkontroller.ru/esp32-projects/kak-rabotaet-ultrazvukovoj-datchik-hc-sr04-i-kak-ego-podklyuchit-k-esp32/
 * 
 * 4. Измерение уровня воды:
 *    - Датчик устанавливается над поверхностью воды в контейнере
 *    - Измеряется расстояние от датчика до поверхности воды
 *    - Уровень воды = глубина контейнера - измеренное расстояние
 *    - Глубина контейнера задается через метод setContainerDepth()
 * 
 * 5. Важные замечания:
 *    - Диапазон измерения: 2-400 см (за пределами этого диапазона измерения ненадежны)
 *    - Для точности измерения необходимо откалибровать датчик,
 *      для этого измеряем расстояние линейкой и УЗ датчиком, находим коэффициенты пересчета
 *    - Угол измерения: около 15°
 *    - На точность влияют температура и влажность воздуха
 *    - Избегайте попадания воды на датчик
 *    - Рекомендуется делать несколько измерений и усреднять результат
 * 
 * 6. Характеристики:
 *    - Рабочее напряжение: 5V DC
 *    - Потребляемый ток: 15mA
 *    - Диапазон измерения: 2-400 см
 *    - Точность: ~0.3 см
 *    - Эффективный угол измерения: 15°
 *    - Частота ультразвука: 40 кГц
 */

#pragma once

#include "sensors/ISensor.h"
#include "config/constants.h"

namespace farm::sensors
{
    class HCSR04 : public ISensor
    {
    private:
        uint8_t trigPin;
        uint8_t echoPin;
        
        // Расстояние от датчика до дна контейнера (см)
        float containerDepth;

        // Коэффициенты калибровки; real = A * measured + B
        double A;
        double B;
        
    public:
        HCSR04(std::shared_ptr<log::ILogger> logger, uint8_t trigPin, uint8_t echoPin);
        
        bool initialize() override;
        
        // Считать уровень воды в процентах
        float read() override;
        
        // Считать расстояние до поверхности воды в сантиметрах (без преобразования в проценты)
        float readDistance();
        
        void setContainerDepth(float depth);  
        float getContainerDepth() const;
    };
} 