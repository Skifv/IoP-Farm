/*
 * Датчик расхода воды YFS401 (расходомер воды)
 * 
 * Принцип работы:
 * 1. Физическая конструкция: 
 *    - Внутри пластикового корпуса расположена вращающаяся крыльчатка с магнитом
 *    - Рядом с крыльчаткой установлен датчик Холла, реагирующий на магнитное поле
 * 
 * 2. Принцип измерения:
 *    - При протекании воды через датчик крыльчатка вращается
 *    - На каждом обороте крыльчатки магнит проходит рядом с датчиком Холла
 *    - Датчик Холла генерирует импульс, когда магнит находится рядом
 *    - Частота импульсов прямо пропорциональна скорости потока воды
 * 
 * 3. Подключение:
 *    - Красный провод (VCC) → 5V (важно использовать 5V, а не 3.3V для стабильной работы)
 *    - Черный провод (GND) → GND
 *    - Желтый провод (сигнальный) → цифровой пин ESP32, поддерживающий прерывания
 *    - Направление потока воды должно соответствовать стрелке на корпусе датчика
 *    - Рекомендуется использовать гидравлические фитинги диаметром 1/2" для подключения
 *Р
 * 4. Работа с прерываниями:
 *    - Сигнальный провод датчика подключается к пину ESP32, настроенному на прерывания
 *    - В обработчике прерываний просто увеличивается счетчик импульсов
 *    - Используется тип прерывания RISING - срабатывание на нарастающем фронте сигнала
 *    - Обработчик помечен атрибутом IRAM_ATTR для быстрого выполнения из RAM
 * 
 * 5. Расчет объема:
 *    - Общий объем воды = количество импульсов / калибровочный коэффициент
 *    - Типичный калибровочный коэффициент: ~450 импульсов на литр
 * 
 * 6. Калибровка датчика:
 *    - Пропустить через датчик известный объем воды (например, ровно 1 литр)
 *    - Подсчитать количество зарегистрированных импульсов
 *    - Калибровочный коэффициент = количество импульсов / объем воды в литрах
 *    - Установить полученный коэффициент через метод setCalibrationFactor()
 * 
 * 7. Характеристики:
 *    - Рабочее напряжение: 5В DC
 *    - Рабочий диапазон расхода: 1-30 л/мин
 *    - Рабочее давление: до 1.75 МПа
 *    - Рабочая температура: 0°C - 80°C
 *    - Точность: ±5-10%
 *    - Резьба для подключения: G1/2"
 */

#pragma once

#include "sensors/ISensor.h"
#include "config/constants.h"

namespace farm::sensors
{
    // Датчик расхода воды
    class YFS401 : public ISensor
    {
    private:
        uint8_t pin;
        
        // Калибровочный коэффициент (импульсы на литр)
        float calibrationFactor;
        
        // Счетчик импульсов (volatile т.к. изменяется в прерывании)
        // https://habr.com/ru/articles/673428/
        volatile unsigned long pulseCount;
        
        // Время последнего обновления (миллисекунды)
        unsigned long lastUpdateTime;
        
    public:
        YFS401(std::shared_ptr<log::ILogger> logger, uint8_t pin);
        
        ~YFS401();
        
        bool initialize() override;
        
        // Считать объем воды в литрах с момента последнего сброса счетчика
        float read() override;
        
        // Переопределение метода сохранения (не используется для этого датчика)
        bool saveMeasurement() override;
        
        void resetCounter();
        
        // Установить коэффициент калибровки (импульсы на литр)
        void setCalibrationFactor(float factor);
        
        // Зарегистрировать импульс (вызывается из ISR)
        void pulse();
        
        // Получить общий объем воды в литрах с момента последнего сброса счетчика
        float getTotalVolume() const;
        
        bool enable(bool enable);
        
        // Получить указатель на единственный экземпляр (для прерывания)
        static YFS401* getInstance();
    
    private:
        // Статический указатель на единственный экземпляр (для прерывания)
        static YFS401* s_instance;
    };
} 